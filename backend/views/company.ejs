<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Daftar Perusahaan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <style>
      td {
        max-width: 200px; /* Sesuaikan dengan lebar maksimal yang diinginkan */
        word-wrap: break-word;
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <div class="flex h-screen">
      <!-- Sidebar -->
      <div class="w-64 bg-white shadow-md">
        <div class="p-6">
          <h1 class="text-2xl font-bold mb-6">Daftar Perusahaan</h1>
          <ul>
            <li class="mb-4">
              <a
                class="flex items-center text-gray-700 hover:text-gray-900"
                href="#"
              >
                <i class="fas fa-chart-line mr-3"> </i>
                <span> Analytics </span>
              </a>
            </li>
            <li class="mb-4">
              <a class="flex items-center text-green-500 font-bold" href="#">
                <i class="fas fa-building mr-3"> </i>
                <span> Daftar Perusahaan </span>
              </a>
            </li>
            <li class="mb-4">
              <a
                class="flex items-center text-gray-700 hover:text-gray-900"
                href="#"
              >
                <i class="fas fa-bars mr-3"> </i>
                <span> Menu </span>
              </a>
            </li>
            <li>
              <a
                class="flex items-center text-gray-700 hover:text-gray-900"
                href="#"
              >
                <i class="fas fa-sign-out-alt mr-3"> </i>
                <span> Log Out </span>
              </a>
            </li>
          </ul>
        </div>
      </div>
      <!-- Main Content -->
      <div class="flex-1 flex flex-col">
        <!-- Header -->
        <header class="bg-green-500 p-4 flex justify-between items-center">
          <div class="text-white text-lg font-bold">Daftar Perusahaan</div>
          <div class="flex items-center">
            <input
              class="p-2 rounded-md border border-gray-300 mr-4"
              placeholder="Search anything..."
              type="text"
            />
            <button
              type="button"
              class="bg-yellow-400 text-white px-4 py-2 rounded-md mr-4"
              data-bs-toggle="modal"
              data-bs-target="#exampleModal"
            >
              + Tambah Perusahaan
            </button>
            <div
              class="modal fade"
              id="exampleModal"
              tabindex="-1"
              aria-labelledby="exampleModalLabel"
              aria-hidden="true"
            >
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header" >
                    <h1 class="modal-title fs-5" id="exampleModalLabel">
                      Tambah Data
                    </h1>
                    <button
                      type="button"
                      class="btn-close"
                      data-bs-dismiss="modal"
                      aria-label="Close"
                    ></button>
                  </div>
                  <div class="modal-body">
                    <div class="mb-3">
                      <label for="name" class="form-label">Name</label>
                      <input
                        type="text"
                        class="form-control"
                        placeholder="Name"
                        aria-label="Name"
                        name="name"
                        id="name"
                        aria-describedby="addon-wrapping"
                      />
                    </div>
                    <div class="mb-3">
                      <label for="store_name" class="form-label">Store Name</label>
                      <input
                        type="text"
                        class="form-control"
                        placeholder="Store Name"
                        aria-label="Store Name"
                        name="store_name"
                        id="store_name"
                        aria-describedby="addon-wrapping"
                      />
                    </div>
                    <div class="mb-3">
                      <label for="address" class="form-label">Address</label>
                      <input
                        type="text"
                        class="form-control"
                        placeholder="Address"
                        aria-label="Address"
                        name="address"
                        id="address"
                        aria-describedby="addon-wrapping"
                      />
                    </div>
                    <div class="mb-3">
                       <label for="type" class="form-label">Type</label>
                     <select name="id_type" id="type" class="form-select">
                      <option selected>=== Pilih Type ===</option>
                      <% dataType.forEach((t) => { %>
                        <option value="<%= t._id  %>"><%= t.type  %></option>
                        <% }) %>
                     </select>
                    </div>
                    <div class="mb-3">
                       <label for="status" class="form-label">Status</label>
                     <select name="status" id="type" class="form-select">
                      <option selected>=== Pilih Status ===</option>
                      <option value="0">Active</option>
                      <option value="1">Inactive</option>
                     </select>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button
                      type="button"
                      class="btn btn-secondary"
                      data-bs-dismiss="modal"
                    >
                      Close
                    </button>
                    <button type="button" class="btn btn-primary">
                      Save changes
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <i class="fas fa-th-large text-white text-xl mr-4"> </i>
            <img
              alt="User profile picture"
              class="rounded-full"
              height="40"
              src="https://storage.googleapis.com/a1aa/image/HXmX3EafRP8SkyEH9n9gnOOAqR0O-lJt4_efQNkt9sk.jpg"
              width="40"
            />
          </div>
        </header>
        <!-- Content -->
        <div class="p-6 flex-1 overflow-y-auto">
          <div class="bg-white shadow-md rounded-lg p-4">
            <table class="w-full text-left">
              <thead>
                <tr class="text-gray-500">
                  <th class="py-2">Nama Perusahaan</th>
                  <th class="py-2">Alamat</th>
                  <th class="py-2">Status</th>
                  <th class="py-2">Aksi</th>
                </tr>
              </thead>
              <tbody>
                <% data.forEach((c) => { %>
                <tr class="border-t">
                  <td class="py-2"><%= c.name %></td>
                  <td class="py-2"><%= c.address %></td>
                  <td class="py-2">
                    <label class="switch">
                      <input type="checkbox" data-id="<%= c._id %>"
                      onchange="updateStatus(this)" <%= c.status == 0 ?
                      'checked' : '' %>>
                      <span class="slider"></span>
                    </label>
                  </td>
                  <td class="py-2 text-right">
                    <button
                      type="button"
                      class="btn btn-danger"
                      onclick="editModals('<%= c._id %>')"
                    >
                      Edit
                    </button>
                    <button
                      type="button"
                      class="btn btn-primary"
                      onclick=""
                    >
                      Detail
                    </button>
                  </td>
                </tr>

                <% }) %>
              </tbody>
            </table>
            <div class="flex justify-between items-center mt-4">
              <div>
                <label class="text-gray-500" for="rows"> Show rows: </label>
                <select
                  class="ml-2 p-2 border border-gray-300 rounded-md"
                  id="rows"
                >
                  <option>10 items</option>
                  <option>20 items</option>
                  <option>30 items</option>
                </select>
              </div>
              <div class="flex items-center">
                <button class="p-2 border border-gray-300 rounded-md mr-2">
                  1
                </button>
                <button class="p-2 border border-gray-300 rounded-md mr-2">
                  2
                </button>
                <button class="p-2 border border-gray-300 rounded-md mr-2">
                  3
                </button>
                <span class="p-2"> ... </span>
                <button class="p-2 border border-gray-300 rounded-md">
                  50
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
     
    </div>
   
    <style>
      .switch {
        position: relative;
        display: inline-block;
        width: 34px;
        height: 20px;
      }
      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 34px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 14px;
        width: 14px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: #ffcc00;
      }
      input:checked + .slider:before {
        transform: translateX(14px);
      }
    </style>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script>
      async function updateStatus(checkbox) {
        const productId = checkbox.getAttribute("data-id");
        const newStatus = checkbox.checked ? 0 : 1; // Convert boolean to number

        try {
          const response = await fetch("/company/editcompany", {
            method: "POST", // Ensure PATCH is used
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              id: productId,
              status: newStatus,
            }),
          });

          const result = await response.json();

          if (!response.ok) {
            alert("Gagal memperbarui status: " + result.message);
            checkbox.checked = !checkbox.checked; // Revert UI if failed
          }
        } catch (error) {
          console.error("Error:", error);
          alert("Terjadi kesalahan!");
          checkbox.checked = !checkbox.checked; // Revert UI if failed
        }
      }

          async function deleteCompany(companyId) {
        if (confirm("Apakah kamu yakin ingin menghapus company ini?")) {
          try {
            // Fetch daftar user
            const responseUser = await fetch("http://localhost:3000/listuser");
            const resultUser = await responseUser.json();
            const responseStore = await fetch("http://localhost:3000/liststore");
            const resultStore = await responseStore.json();

            if (resultUser.find(d => d.id_company == companyId) && resultStore.find(d => d.id_company == companyId)) {
              alert("Tidak bisa menghapus! Masih ada yang terhubung ke company ini.");
              return;
            }

            const response = await fetch(`/api/company/${companyId}`, {
              method: "DELETE",
            });

            if (!response.ok) {
              const err = await response.json();
              throw new Error(err.error || "Terjadi kesalahan saat menghapus");
            }

            const data = await response.json();
            alert(data.message || "Company berhasil dihapus");
            location.reload(); 
          } catch (error) {
            alert("Error: " + error.message);
          }
        }
      }

      async function showModals(id) {
        const modalId = `modal-${id}`;

        const data = await getcompany(id);
        const datatype = await gettype(data.id_type);

        let modalElement = document.getElementById(modalId);

        if (!modalElement) {
          const modalHTML = `
          <div class="modal fade" id="${modalId}" tabindex="-1" aria-labelledby="${modalId}Label" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="${modalId}Label">Detail</h5>
                 <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                 <div class="modal-body">
              <p><strong>ID:</strong> ${data._id}</p>
              <p><strong>Name:</strong> ${data.name}</p>
              <p><strong>Store Name:</strong> ${data.store_name}</p>
              <p><strong>Address:</strong> ${data.address}</p>
              <p><strong>Type ID:</strong> ${datatype.type}</p>
              <p><strong>Status:</strong> ${
                data.status === 1 ? "Active" : "Inactive"
              }</p>
              <p><strong>Created At:</strong> ${new Date(
                data.created_at
              ).toLocaleString()}</p>
            </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  <button type="button" class="btn btn-danger">Delete</button>
                </div>
              </div>
            </div>
          </div>
        `;

          // Append the modal to the body
          document.body.insertAdjacentHTML("beforeend", modalHTML);
          modalElement = document.getElementById(modalId);
        }

        // Show the modal using Bootstrap's Modal class
        const myModal = new bootstrap.Modal(modalElement);
        myModal.show();
      }
      async function editModals(id) {
        // Create a unique modal ID
        const modalId = `modal-${id}`;

        const data = await getcompany(id);
        const datatype = await gettype(data.id_type);
        console.log(data.status)

        let modalElement = document.getElementById(modalId);

        if (!modalElement) {
          const modalHTML = `
          <div class="modal fade" id="${modalId}" tabindex="-1" aria-labelledby="${modalId}Label" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="${modalId}Label">Detail</h5>
                 <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
<form action="/company/editcompany" method="post">
                   <div class="modal-body">
                    <div class="mb-3">
                      <label for="name" class="form-label">Name</label>
                      <input
                        type="text"
                        class="form-control"
                        placeholder="Name"
                        aria-label="Name"
                        name="name"
                        id="name"
                        value="${data.name}"
                        aria-describedby="addon-wrapping"
                      />
                      <input
                        type="hidden"
                        name="id"
                        id="id"
                        value="${data._id}"
                        aria-describedby="addon-wrapping"
                      />
                    </div>
                    <div class="mb-3">
                      <label for="store_name" class="form-label">Store Name</label>
                      <input
                        type="text"
                        class="form-control"
                        placeholder="Store Name"
                        aria-label="Store Name"
                        name="store_name"
                        id="store_name"
                        value="${data.store_name}"
                        aria-describedby="addon-wrapping"
                      />
                    </div>
                    <div class="mb-3">
                      <label for="address" class="form-label">Address</label>
                      <input
                        type="text"
                        class="form-control"
                        placeholder="Address"
                        aria-label="Address"
                        name="address"
                        id="address"
                        value="${data.address}"
                        aria-describedby="addon-wrapping"
                      />
                    </div>
                    <div class="mb-3">
                      <label for="type" class="form-label">Type</label>
                      <select name="id_type" id="type" class="form-select">
                        <% dataType.forEach((t) => { %>
                          <option value="<%= t._id  %>" <%= data.id_type == dataType._id ? "selected" : ""   %> > <%= t.type  %></option>
                          <% }) %>
                          </select>
                          </div>
                          <div class="mb-3">
                            <label for="status" class="form-label">Status</label>
                            <select name="status" id="type" class="form-select">
                             <option value="0"  ${data.status == 0 ? "selected" : ""}>Active</option>
<option value="1" ${data.status == 1 ? "selected" : ""}>Inactive</option>

                              </select>
                              </div>
                              <div class="mb-3">
                                <label for="address" class="form-label">Created At</label>
                                <input
                                  type="text"
                                  class="form-control"
                                  placeholder="Created At"
                                  aria-label="Created At"
                                  name="created_at"
                                  id="created_at"
                                  value="${new Date(
                data.created_at
              ).toLocaleString()}"
              disabled
                                  aria-describedby="addon-wrapping"
                                />
                              </div>
                  </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  <button type="submit" class="btn btn-primary">Save changes</button>
                </div>
                 </form>
              </div>
            </div>
          </div>
        `;

          // Append the modal to the body
          document.body.insertAdjacentHTML("beforeend", modalHTML);
          modalElement = document.getElementById(modalId);
        }

        // Show the modal using Bootstrap's Modal class
        const myModal = new bootstrap.Modal(modalElement);
        myModal.show();
      }
      async function getcompany(id) {
        try {
          const response = await fetch("/company/getcompany", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ id: id }),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }

          const data = await response.json();
          return data; // Return the JSON data
        } catch (error) {
          console.error("Error fetching user:", error);
          return null;
        }
      }
      async function gettype(id) {
        try {
          const response = await fetch("/type/gettype", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ id: id }),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }

          const data = await response.json();
          return data; // Return the JSON data
        } catch (error) {
          console.error("Error fetching user:", error);
          return null;
        }
      }
    </script>
  </body>
</html>
